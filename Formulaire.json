{"files":[{"id":"bdf5d209-afd7-4fcc-87ff-b2d2b53e8a49","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Africa/Algiers\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  },\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}"},{"id":"ccf23f5a-d472-440a-a6c1-c743d6b7f3a1","name":"Commandes","type":"server_js","source":"/**\n * Configuration principale\n */\nconst CONFIG \u003d {\n  SS_COMMANDES_ID: \"1b8obvuesQZZB0tI139Dz_8ErlmFPtKrt3-P7HPRlPBw\",\n  RATE_LIMIT_MS: 5000,\n  URL_De_Base: \"https://soweg.online/Commandes/v4/\"\n};\n\n/**\n * Point d‚Äôentr√©e : r√©ception des commandes\n */\nfunction doPost(e) {\n  try {\n    if (!e?.postData?.contents)\n      throw new Error(\"Aucune donn√©e re√ßue.\");\n\n    const data \u003d JSON.parse(e.postData.contents);\n\n    // --- Nettoyage et validation\n    const articleCode \u003d clean(data.article);\n    const qtt \u003d parseInt(data.qtt, 10) || 0;\n    const tel \u003d clean(data.tel);\n    const numWilaya \u003d clean(data.wilaya); // contient uniquement le num√©ro, ex: \"16\"\n\n    if (!Verif_Phone(data.tel)) return ContentService.createTextOutput(\"‚ùå Num√©ro de t√©l√©phone invalide. Exemple : 0550123456 ou 021123456\");\n\n\n    if (!articleCode || !qtt || !tel)\n      throw new Error(\"Champs requis manquants (article, quantit√© ou t√©l√©phone).\");\n\n    // --- Protection anti-spam\n    if (!rateLimit(tel, CONFIG.RATE_LIMIT_MS)) {\n      return reponseTexte(\"Trop de requ√™tes √† la fois, r√©essayez dans un instant !\");\n    }\n\n    // --- Chargement des donn√©es\n    const catalogue \u003d getCatalogue();\n    const wilayas \u003d getWilayas();\n\n    const articleData \u003d catalogue[articleCode];\n    if (!articleData) throw new Error(`Article inconnu : ${articleCode}`);\n\n    // --- Trouver la wilaya correspondante\n    const w \u003d wilayas.find(w \u003d\u003e String(w.num) \u003d\u003d\u003d String(numWilaya));\n    if (!w) throw new Error(`Wilaya inconnue : ${numWilaya}`);\n\n\n    // --- R√©cup√©rer le mode de livraison envoy√©\n    const modeLivraison \u003d clean(data.modeLivraison) || \"domicile\";\n    const nomDesk \u003d clean(data.nomDesk || \"\"); // üîπ r√©cup√®re le nom du desk envoy√© par le formulaire\n\n    // --- Calculer le montant exact selon le mode\n    let livraison \u003d 0;\n    if (modeLivraison \u003d\u003d\u003d \"domicile\") {\n      livraison \u003d w.domicile || 0;\n    } else if (modeLivraison \u003d\u003d\u003d \"desk\") {\n      livraison \u003d w.desk || 0;\n    }\n\n\n    // --- Calculs\n    const prixUnitaire \u003d articleData.prix || 0;\n    const remise \u003d calculerRemise(articleData, qtt);\n    const total_brut \u003d prixUnitaire * qtt;\n    const total \u003d total_brut - remise + (livraison || 0);\n  \n\n    // --- √âcriture dans la feuille\n    const sheet \u003d SpreadsheetApp.openById(CONFIG.SS_COMMANDES_ID).getSheetByName(\"Commandes\");\n    const row \u003d [\n      Utilities.formatDate(new Date(), \"Africa/Algiers\", \"yyyy-MM-dd HH:mm:ss\"),\n      articleCode,\n      qtt,\n      formatDA(total_brut),\n      \u0027 (\u0027+ modeLivraison+\u0027) \u0027+formatDA(livraison) ,   \n      formatDA(remise),         \n      formatDA(total),\n      clean(data.nom_prenom),\n      tel,\n      `${w.fr}`,\n      clean(data.commune),\n      \"En attente\",\n      nomDesk\n    ];\n\n    sheet.appendRow(row);\n\n    return reponseTexte(\"OK\");\n\n  } catch (err) {\n    return reponseTexte(\"Erreur : \" + err.message);\n  }\n}\n\n/**\n * Chargement du catalogue depuis un JSON public\n */\nfunction getCatalogue() {\n  const url \u003d CONFIG.URL_De_Base + \"Articles.json\";\n  try {\n    const response \u003d UrlFetchApp.fetch(url, { muteHttpExceptions: true });\n    if (response.getResponseCode() !\u003d\u003d 200)\n      throw new Error(`√âchec du chargement du catalogue (${response.getResponseCode()})`);\n\n    const catalogue \u003d JSON.parse(response.getContentText());\n    if (typeof catalogue !\u003d\u003d \"object\" || Object.keys(catalogue).length \u003d\u003d\u003d 0)\n      throw new Error(\"Catalogue vide ou format invalide.\");\n\n    return catalogue;\n  } catch (err) {\n    Logger.log(\"Erreur lors du chargement du catalogue : \" + err);\n    throw new Error(\"Impossible de charger le catalogue : \" + err.message);\n  }\n}\n\n/**\n * Chargement des wilayas depuis un JSON public\n */\nfunction getWilayas() {\n  const url \u003d CONFIG.URL_De_Base + \"Wilayas.json\";\n  try {\n    const response \u003d UrlFetchApp.fetch(url, { muteHttpExceptions: true });\n    if (response.getResponseCode() !\u003d\u003d 200)\n      throw new Error(`√âchec du chargement des wilayas (${response.getResponseCode()})`);\n\n    const wilayas \u003d JSON.parse(response.getContentText());\n    if (!Array.isArray(wilayas) || wilayas.length \u003d\u003d\u003d 0)\n      throw new Error(\"Wilayas vides ou format invalide.\");\n\n    return wilayas;\n  } catch (err) {\n    Logger.log(\"Erreur lors du chargement des wilayas : \" + err);\n    throw new Error(\"Impossible de charger les wilayas : \" + err.message);\n  }\n}\n"},{"id":"fa7edfe1-7705-4bab-9c4c-b8949c25ead6","name":"Utils","type":"server_js","source":"/**\n * Calcul des remises selon quantit√©\n */\nfunction calculerRemise(article, qtt) {\n  if (qtt \u003e\u003d 4) return article.remise_x4 || 0;\n  if (qtt \u003d\u003d\u003d 3) return article.remise_x3 || 0;\n  if (qtt \u003d\u003d\u003d 2) return article.remise_x2 || 0;\n  return 0;\n}\n\n/**\n * Format mon√©taire alg√©rien\n */\nfunction formatDA(montant) {\n  return new Intl.NumberFormat(\"fr-DZ\", {\n    style: \"currency\",\n    currency: \"DZD\",\n    minimumFractionDigits: 0\n  }).format(montant);\n}\n\n\nfunction Verif_Phone(tel) \n{\n  if (!tel) return false;\n  \n  // Supprimer espaces, tirets, parenth√®ses\n  tel \u003d String(tel).trim().replace(/[\\s\\-\\(\\)]/g, \"\");\n  \n  // G√©rer le format international +213\n  if (tel.startsWith(\"+213\")) {\n    tel \u003d \"0\" + tel.slice(4);\n  }\n\n  // V√©rification du format mobile (05,06,07) ou fixe (02,03,04)\n  const regex \u003d /^(0(5|6|7)\\d{8}|0(2|3|4)\\d{7})$/;\n  return regex.test(tel);\n}\n\n\n/**\n * Nettoyage des entr√©es utilisateurs\n */\nfunction clean(value) {\n  if (typeof value !\u003d\u003d \"string\") return \"\";\n  return value.replace(/[\u003c\u003e\u003d;]/g, \"\").trim();\n}\n\n/**\n * Protection anti-flood\n */\nfunction rateLimit(key, delayMs) {\n  const props \u003d PropertiesService.getScriptProperties();\n  const uniqueKey \u003d \"limit_\" + key;\n  const now \u003d Date.now();\n  const last \u003d parseInt(props.getProperty(uniqueKey)) || 0;\n\n  if (now - last \u003c delayMs) return false;\n\n  props.setProperty(uniqueKey, String(now));\n  return true;\n}\n\n/**\n * G√©n√©ration d‚Äôune r√©ponse HTTP texte\n */\nfunction reponseTexte(msg) {\n  return ContentService\n    .createTextOutput(msg)\n    .setMimeType(ContentService.MimeType.TEXT);\n}\n\n"}]}